{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/camps/cleanswift/web-dashboard/proxy.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\nimport { NextResponse, type NextRequest } from 'next/server';\n\nexport async function proxy(request: NextRequest) {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    console.error('Missing Supabase environment variables. Please check your .env.local file.');\n    return NextResponse.json(\n      { error: 'Server configuration error: Missing Supabase credentials' },\n      { status: 500 }\n    );\n  }\n\n  let supabaseResponse = NextResponse.next({\n    request: {\n      headers: request.headers,\n    },\n  });\n\n  const supabase = createServerClient(\n    supabaseUrl,\n    supabaseAnonKey,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll();\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value, options }) =>\n            request.cookies.set(name, value)\n          );\n          supabaseResponse = NextResponse.next({\n            request,\n          });\n          cookiesToSet.forEach(({ name, value, options }) =>\n            supabaseResponse.cookies.set(name, value, options)\n          );\n        },\n      },\n    }\n  );\n\n  // Use getUser() instead of getSession() for more reliable authentication\n  // getSession() reads from cookies which may not be immediately updated after login\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  \n  // Get session separately for role checks\n  const {\n    data: { session },\n  } = await supabase.auth.getSession();\n\n  const { pathname } = request.nextUrl;\n\n  // Protect detailer routes\n  if (pathname.startsWith('/detailer')) {\n    if (!user || !session) {\n      return NextResponse.redirect(new URL('/auth/login', request.url));\n    }\n\n    // Check user role\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    if (profileError || !profile || (profile.role !== 'detailer' && profile.role !== 'admin')) {\n      return NextResponse.redirect(new URL('/auth/login', request.url));\n    }\n  }\n\n  // Protect admin routes\n  if (pathname.startsWith('/admin')) {\n    if (!user || !session) {\n      return NextResponse.redirect(new URL('/auth/login', request.url));\n    }\n\n    // Check user role\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    if (profileError || !profile || profile.role !== 'admin') {\n      return NextResponse.redirect(new URL('/auth/login', request.url));\n    }\n  }\n\n  // Redirect authenticated users away from login page\n  if (pathname.startsWith('/auth/login') && user && session) {\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    // Only redirect if we successfully got the profile\n    // If there's an error, let the login page handle it (might be RLS issue)\n    if (profile && !profileError) {\n      if (profile.role === 'admin') {\n        return NextResponse.redirect(new URL('/admin/dashboard', request.url));\n      } else if (profile.role === 'detailer') {\n        return NextResponse.redirect(new URL('/detailer/dashboard', request.url));\n      }\n    }\n    // If profile query failed, don't redirect - let user stay on login page\n    // This prevents redirect loops when RLS blocks the query\n  }\n\n  return supabaseResponse;\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ],\n};\n\n"],"names":[],"mappings":"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"}}]
}