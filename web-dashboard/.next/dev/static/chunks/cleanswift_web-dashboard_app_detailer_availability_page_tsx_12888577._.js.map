{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/camps/cleanswift/web-dashboard/app/detailer/availability/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { createClient } from '@/lib/supabase/client';\nimport { useRouter } from 'next/navigation';\n\ninterface AvailabilitySlot {\n  id: string;\n  day_of_week: number;\n  start_time: string;\n  end_time: string;\n  is_active: boolean;\n}\n\ninterface UserProfile {\n  id: string;\n  role: 'user' | 'detailer' | 'admin';\n}\n\nconst DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n\n// Permission-related error messages from the RPC function\nconst PERMISSION_ERRORS = [\n  'Only detailers and admins can view availability',\n  'Only detailers can set availability',\n  'Not authenticated',\n  'User profile not found',\n  'Detailer profile not found',\n];\n\nexport default function AvailabilityPage() {\n  const [availability, setAvailability] = useState<AvailabilitySlot[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [isAdmin, setIsAdmin] = useState(false);\n  const [hasDetailerRecord, setHasDetailerRecord] = useState(true);\n  const router = useRouter();\n  const supabase = createClient();\n\n  // Check if error is permission-related\n  const isPermissionError = (errorMessage: string): boolean => {\n    return PERMISSION_ERRORS.some(permError => \n      errorMessage.toLowerCase().includes(permError.toLowerCase())\n    );\n  };\n\n  // Verify user authentication and role\n  const verifyUser = useCallback(async (): Promise<UserProfile | null> => {\n    const { data: { session } } = await supabase.auth.getSession();\n    \n    if (!session?.user) {\n      router.push('/auth/login');\n      return null;\n    }\n\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('id, role')\n      .eq('id', session.user.id)\n      .single();\n\n    if (!profile) {\n      router.push('/auth/login');\n      return null;\n    }\n\n    // Check if user has permission to access this page\n    if (profile.role !== 'detailer' && profile.role !== 'admin') {\n      router.push('/auth/login');\n      return null;\n    }\n\n    setIsAdmin(profile.role === 'admin');\n    return profile as UserProfile;\n  }, [supabase, router]);\n\n  // Check if detailer record exists for this user\n  const checkDetailerRecord = useCallback(async (profileId: string): Promise<boolean> => {\n    const { data } = await supabase\n      .from('detailers')\n      .select('id')\n      .eq('profile_id', profileId)\n      .single();\n\n    return !!data;\n  }, [supabase]);\n\n  const fetchAvailability = useCallback(async () => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      // First verify the user\n      const profile = await verifyUser();\n      if (!profile) return;\n\n      // Check if detailer record exists\n      const hasRecord = await checkDetailerRecord(profile.id);\n      setHasDetailerRecord(hasRecord);\n\n      // If admin without detailer record, show empty state (not an error)\n      if (profile.role === 'admin' && !hasRecord) {\n        setAvailability([]);\n        setLoading(false);\n        return;\n      }\n\n      // Fetch availability\n      const { data, error: fetchError } = await supabase.rpc('get_detailer_availability');\n\n      if (fetchError) {\n        // Handle permission errors by redirecting\n        if (isPermissionError(fetchError.message)) {\n          router.push('/auth/login');\n          return;\n        }\n        throw fetchError;\n      }\n      \n      setAvailability(data || []);\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to load availability';\n      \n      // Check for permission errors and redirect\n      if (isPermissionError(errorMessage)) {\n        router.push('/auth/login');\n        return;\n      }\n      \n      setError(errorMessage);\n    } finally {\n      setLoading(false);\n    }\n  }, [supabase, router, verifyUser, checkDetailerRecord]);\n\n  // Load availability on mount\n  useEffect(() => {\n    fetchAvailability();\n  }, [fetchAvailability]);\n\n  const handleToggleDay = async (dayOfWeek: number) => {\n    try {\n      setSaving(true);\n      setError(null);\n\n      const existingSlot = availability.find((slot) => slot.day_of_week === dayOfWeek);\n\n      if (existingSlot) {\n        // Toggle existing slot\n        const { error: updateError } = await supabase.rpc('set_detailer_availability', {\n          p_day_of_week: dayOfWeek,\n          p_start_time: existingSlot.start_time,\n          p_end_time: existingSlot.end_time,\n          p_is_active: !existingSlot.is_active,\n        });\n\n        if (updateError) {\n          if (isPermissionError(updateError.message)) {\n            router.push('/auth/login');\n            return;\n          }\n          throw updateError;\n        }\n      } else {\n        // Create new slot with default hours (9 AM - 5 PM)\n        const { error: createError } = await supabase.rpc('set_detailer_availability', {\n          p_day_of_week: dayOfWeek,\n          p_start_time: '09:00:00',\n          p_end_time: '17:00:00',\n          p_is_active: true,\n        });\n\n        if (createError) {\n          if (isPermissionError(createError.message)) {\n            router.push('/auth/login');\n            return;\n          }\n          throw createError;\n        }\n      }\n\n      await fetchAvailability();\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to update availability';\n      if (isPermissionError(errorMessage)) {\n        router.push('/auth/login');\n        return;\n      }\n      setError(errorMessage);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleTimeChange = async (dayOfWeek: number, field: 'start_time' | 'end_time', value: string) => {\n    try {\n      setSaving(true);\n      setError(null);\n\n      const existingSlot = availability.find((slot) => slot.day_of_week === dayOfWeek);\n      const timeValue = value.includes(':') && value.split(':').length === 2 ? `${value}:00` : value;\n\n      const { error: updateError } = await supabase.rpc('set_detailer_availability', {\n        p_day_of_week: dayOfWeek,\n        p_start_time: field === 'start_time' ? timeValue : existingSlot?.start_time || '09:00:00',\n        p_end_time: field === 'end_time' ? timeValue : existingSlot?.end_time || '17:00:00',\n        p_is_active: existingSlot?.is_active ?? true,\n      });\n\n      if (updateError) {\n        if (isPermissionError(updateError.message)) {\n          router.push('/auth/login');\n          return;\n        }\n        throw updateError;\n      }\n      await fetchAvailability();\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to update time';\n      if (isPermissionError(errorMessage)) {\n        router.push('/auth/login');\n        return;\n      }\n      setError(errorMessage);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const getSlotForDay = (dayOfWeek: number) => {\n    return availability.find((slot) => slot.day_of_week === dayOfWeek);\n  };\n\n  const formatTime = (time: string) => {\n    return time.substring(0, 5); // HH:mm\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-[#050B12] text-white flex items-center justify-center\">\n        <div className=\"text-[#C6CFD9]\">Loading availability...</div>\n      </div>\n    );\n  }\n\n  // Admin without detailer record - show informative message\n  if (isAdmin && !hasDetailerRecord) {\n    return (\n      <div className=\"min-h-screen bg-[#050B12] text-white\">\n        <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n          <div className=\"mb-8\">\n            <h1 className=\"text-3xl font-bold text-white mb-2\">Availability Management</h1>\n            <p className=\"text-[#C6CFD9]\">Set your weekly availability schedule</p>\n          </div>\n\n          <div className=\"bg-[#0A1A2F] border border-white/5 rounded-xl p-6\">\n            <div className=\"text-center py-8\">\n              <div className=\"text-[#C6CFD9] mb-4\">\n                <svg className=\"w-16 h-16 mx-auto mb-4 opacity-50\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-lg font-medium text-white mb-2\">Admin Account</h3>\n              <p className=\"text-[#C6CFD9] text-sm max-w-md mx-auto\">\n                As an admin, you don&apos;t have personal availability to manage. \n                To manage a detailer&apos;s availability, please access their profile directly.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-[#050B12] text-white\">\n      <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold text-white mb-2\">Availability Management</h1>\n          <p className=\"text-[#C6CFD9]\">Set your weekly availability schedule</p>\n        </div>\n\n        {error && (\n          <div className=\"bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-lg text-sm mb-6\">\n            {error}\n          </div>\n        )}\n\n        <div className=\"bg-[#0A1A2F] border border-white/5 rounded-xl p-6\">\n          <div className=\"space-y-4\">\n            {DAY_NAMES.map((dayName, index) => {\n              const slot = getSlotForDay(index);\n              const isActive = slot?.is_active ?? false;\n\n              return (\n                <div\n                  key={index}\n                  className=\"flex items-center justify-between p-4 bg-[#050B12] border border-white/5 rounded-lg\"\n                >\n                  <div className=\"flex items-center gap-4\">\n                    <label className=\"flex items-center gap-3 cursor-pointer\">\n                      <input\n                        type=\"checkbox\"\n                        checked={isActive}\n                        onChange={() => handleToggleDay(index)}\n                        disabled={saving}\n                        className=\"w-5 h-5 rounded border-white/20 bg-[#0A1A2F] text-[#32CE7A] focus:ring-[#32CE7A]\"\n                      />\n                      <span className=\"text-white font-medium w-24\">{dayName}</span>\n                    </label>\n\n                    {isActive && (\n                      <div className=\"flex items-center gap-2\">\n                        <input\n                          type=\"time\"\n                          value={slot ? formatTime(slot.start_time) : '09:00'}\n                          onChange={(e) => handleTimeChange(index, 'start_time', e.target.value)}\n                          disabled={saving}\n                          className=\"px-3 py-2 bg-[#0A1A2F] border border-white/10 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#6FF0C4]\"\n                        />\n                        <span className=\"text-[#C6CFD9]\">to</span>\n                        <input\n                          type=\"time\"\n                          value={slot ? formatTime(slot.end_time) : '17:00'}\n                          onChange={(e) => handleTimeChange(index, 'end_time', e.target.value)}\n                          disabled={saving}\n                          className=\"px-3 py-2 bg-[#0A1A2F] border border-white/10 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#6FF0C4]\"\n                        />\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {saving && (\n            <div className=\"mt-4 text-[#C6CFD9] text-sm\">Saving changes...</div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}}]
}