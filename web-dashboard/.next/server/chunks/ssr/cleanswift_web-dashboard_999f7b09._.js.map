{"version":3,"sources":["../../../../../../cleanswift/web-dashboard/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../../cleanswift/web-dashboard/lib/detailer/permissions.ts","../../../../../../cleanswift/web-dashboard/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../../cleanswift/web-dashboard/app/detailer/bookings/actions.ts","../../../../../../cleanswift/web-dashboard/.next-internal/server/app/detailer/bookings/%5Bid%5D/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","/**\n * Permission utilities for role-based access control\n * Defines what each role can do in the organization\n */\n\nexport enum OrganizationRole {\n  Owner = 'owner',\n  Manager = 'manager',\n  Dispatcher = 'dispatcher',\n  Detailer = 'detailer',\n}\n\nexport type OrganizationRoleType = 'owner' | 'manager' | 'dispatcher' | 'detailer';\n\n/**\n * Check if a role can assign jobs\n */\nexport function canAssignJobs(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager || role === OrganizationRole.Dispatcher;\n}\n\n/**\n * Check if a role can manage teams\n */\nexport function canManageTeams(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager;\n}\n\n/**\n * Check if a role can manage members\n */\nexport function canManageMembers(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager;\n}\n\n/**\n * Check if a role can view organization earnings\n */\nexport function canViewOrgEarnings(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager;\n}\n\n/**\n * Check if a role can manage organization settings\n */\nexport function canManageOrgSettings(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner;\n}\n\n/**\n * Check if a role can change member roles\n */\nexport function canChangeMemberRoles(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner;\n}\n\n/**\n * Check if a role can remove members\n */\nexport function canRemoveMembers(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager;\n}\n\n/**\n * Check if a role can view all organization bookings\n */\nexport function canViewAllOrgBookings(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager || role === OrganizationRole.Dispatcher;\n}\n\n/**\n * Check if a role can update booking status\n */\nexport function canUpdateBookingStatus(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager || role === OrganizationRole.Dispatcher;\n}\n\n/**\n * Check if a role can create payout batches\n */\nexport function canCreatePayoutBatches(role: OrganizationRoleType | null): boolean {\n  if (!role) return false;\n  return role === OrganizationRole.Owner || role === OrganizationRole.Manager;\n}\n\n/**\n * Get all permissions for a role\n */\nexport function getRolePermissions(role: OrganizationRoleType | null) {\n  return {\n    canAssignJobs: canAssignJobs(role),\n    canManageTeams: canManageTeams(role),\n    canManageMembers: canManageMembers(role),\n    canViewOrgEarnings: canViewOrgEarnings(role),\n    canManageOrgSettings: canManageOrgSettings(role),\n    canChangeMemberRoles: canChangeMemberRoles(role),\n    canRemoveMembers: canRemoveMembers(role),\n    canViewAllOrgBookings: canViewAllOrgBookings(role),\n    canUpdateBookingStatus: canUpdateBookingStatus(role),\n    canCreatePayoutBatches: canCreatePayoutBatches(role),\n  };\n}\n\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","'use server';\n\nimport { createClient } from '@/lib/supabase/server';\nimport { requireDetailer, getDetailerMode } from '@/lib/auth';\nimport { getDetailerOrganization, getOrganizationRole } from '@/lib/detailer/mode-detection';\nimport { canAssignJobs } from '@/lib/detailer/permissions';\n\n/**\n * Assign a job to a detailer\n */\nexport async function assignJobToDetailer(bookingId: string, detailerId: string) {\n  const supabase = await createClient();\n  const profile = await requireDetailer();\n\n  // Get booking\n  const { data: booking, error: bookingError } = await supabase\n    .from('bookings')\n    .select('id, organization_id, detailer_id, status')\n    .eq('id', bookingId)\n    .single();\n\n  if (bookingError || !booking) {\n    throw new Error('Booking not found');\n  }\n\n  // Check permissions\n  if (booking.organization_id) {\n    const mode = await getDetailerMode();\n    if (mode === 'organization') {\n      const organization = await getDetailerOrganization();\n      if (organization) {\n        const role = await getOrganizationRole(organization.id);\n        if (!canAssignJobs(role)) {\n          throw new Error('You do not have permission to assign jobs');\n        }\n      }\n    } else {\n      // Solo detailer can only assign to themselves\n      const { data: detailerData } = await supabase.rpc('get_detailer_by_profile', {\n        p_profile_id: null,\n      });\n      if (detailerId !== detailerData?.id) {\n        throw new Error('Solo detailers can only be assigned to themselves');\n      }\n    }\n  } else {\n    // Solo booking - detailer can only assign to themselves\n    const { data: detailerData } = await supabase.rpc('get_detailer_by_profile', {\n      p_profile_id: null,\n    });\n    if (detailerId !== detailerData?.id) {\n      throw new Error('You can only assign jobs to yourself');\n    }\n  }\n\n  // Verify detailer exists and is in the same organization\n  const { data: detailer } = await supabase\n    .from('detailers')\n    .select('id, organization_id')\n    .eq('id', detailerId)\n    .single();\n\n  if (!detailer) {\n    throw new Error('Detailer not found');\n  }\n\n  if (booking.organization_id && detailer.organization_id !== booking.organization_id) {\n    throw new Error('Detailer is not in the same organization');\n  }\n\n  // Update booking\n  const { error: updateError } = await supabase\n    .from('bookings')\n    .update({\n      detailer_id: detailerId,\n      updated_at: new Date().toISOString(),\n    })\n    .eq('id', bookingId);\n\n  if (updateError) {\n    throw new Error('Failed to assign job');\n  }\n\n  // Create timeline entry\n  const { error: timelineError } = await supabase\n    .from('booking_timeline')\n    .insert({\n      booking_id: bookingId,\n      status_from: booking.status,\n      status_to: booking.status, // Status doesn't change, just assignment\n      changed_by: profile.id,\n      notes: `Job assigned to detailer`,\n    });\n\n  if (timelineError) {\n    console.error('Failed to create timeline entry:', timelineError);\n    // Don't throw - assignment succeeded\n  }\n\n  return { success: true };\n}\n\n","export {assignJobToDetailer as '60d858c2f9116937f1ff29a4433a628e709b07024a'} from 'ACTIONS_MODULE0'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[0,2]}